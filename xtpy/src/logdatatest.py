import os,sys
import numpy as np
import pandas as pd

import json

#import CfgUtil
import matplotlib.pyplot as plt

import commonutil

import importutil

pyxt=importutil.import_pyxtcommon()

fitvolcurve_str= '{"dt":"2020-04-20 10:28:06.747155","ll":"LOG_INFO","msgtype":"msg_oc_fitvolcurve","ocname":"oc_cu_o_20200424","fitthreshticks":10,"minoptionpxtick":1,"fittedvols":[0.596288,0.558273,0.516543,0.462159,0.411326,0.367585,0.330677,0.276379,0.246584,0.240065,0.256929,0.295761,0.355112,0.433222,0.495664,0.522756],"cfgdata":{"name":"oc_cu_o_20200424_snapvol","funce":0.002,"miny":0.0005,"maxy":4},"data":{"fitflag":1,"fitfunccount":116,"fitfuncvalue":3.7211298841592328,"fitts":"1593626935844221","fitus":"6053","currminw":24.902791971477377,"currmaxw":1659.7237136035267},"ctrlpoints":{},"datapoints":{"pointsmap":{"36000":{"x":36000,"y":0.462104687026872,"z":0,"v":0,"w":24.902791971477377,"flag":0,"ts":"0"},"38000":{"x":38000,"y":0.4539507828167082,"z":0,"v":0,"w":48.66118481108812,"flag":0,"ts":"0"},"47000":{"x":47000,"y":0.38110555723866651,"z":0,"v":0,"w":55.48124636636156,"flag":0,"ts":"0"},"38500":{"x":38500,"y":0.44948329095887518,"z":0,"v":0,"w":66.93820332004141,"flag":0,"ts":"0"},"42000":{"x":42000,"y":0.24657560533249293,"z":0,"v":0,"w":1659.7237136035267,"flag":0,"ts":"0"},"43000":{"x":43000,"y":0.24006946667041471,"z":0,"v":0,"w":1508.9266809676517,"flag":0,"ts":"0"},"49000":{"x":49000,"y":0.4937790497771572,"z":0,"v":0,"w":28.626099280957259,"flag":0,"ts":"0"},"37500":{"x":37500,"y":0.46844911376976145,"z":0,"v":0,"w":38.021898963739517,"flag":0,"ts":"0"},"44000":{"x":44000,"y":0.27009116745662848,"z":0,"v":0,"w":691.19728991969,"flag":0,"ts":"0"},"46000":{"x":46000,"y":0.35512199947479206,"z":0,"v":0,"w":104.36178166528603,"flag":0,"ts":"0"},"39000":{"x":39000,"y":0.4113235850071229,"z":0,"v":0,"w":99.7154589148902,"flag":0,"ts":"0"},"41000":{"x":41000,"y":0.29727256180639666,"z":0,"v":0,"w":825.30927744290875,"flag":0,"ts":"0"},"48000":{"x":48000,"y":0.45316717085184877,"z":0,"v":0,"w":36.832777865621757,"flag":0,"ts":"0"},"40000":{"x":40000,"y":0.36150780439200325,"z":0,"v":0,"w":275.33026262509327,"flag":0,"ts":"0"},"45000":{"x":45000,"y":0.32640734241749442,"z":0,"v":0,"w":251.62850802474833,"flag":0,"ts":"0"},"39500":{"x":39500,"y":0.37404501524659822,"z":0,"v":0,"w":160.6381619358427,"flag":0,"ts":"0"}},"tagdoublemap":{"13":0.010958904109589041,"12":42370,"0":0.24142561975755705,"11":42370},"tagtoidxmap":{"48000":14,"47000":13,"46000":12,"45000":11,"44000":10,"43000":9,"42000":8,"41000":7,"40000":6,"39500":5,"39000":4,"38500":3,"38000":2,"49000":15,"37500":1,"36000":0},"tags":["36000","37500","38000","38500","39000","39500","40000","41000","42000","43000","44000","45000","46000","47000","48000","49000"],"xs":[36000,37500,38000,38500,39000,39500,40000,41000,42000,43000,44000,45000,46000,47000,48000,49000],"ys":[0.462104687026872,0.46844911376976145,0.4539507828167082,0.44948329095887518,0.4113235850071229,0.37404501524659822,0.36150780439200325,0.29727256180639666,0.24657560533249293,0.24006946667041471,0.27009116745662848,0.32640734241749442,0.35512199947479206,0.38110555723866651,0.45316717085184877,0.4937790497771572],"zs":[0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0],"vs":[0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0],"ws":[24.902791971477377,38.021898963739517,48.66118481108812,66.93820332004141,99.7154589148902,160.6381619358427,275.33026262509327,825.30927744290875,1659.7237136035267,1508.9266809676517,691.19728991969,251.62850802474833,104.36178166528603,55.48124636636156,36.832777865621757,28.626099280957259],"flags":[0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0]},"func":{"doubleparams":[{"curr":0.24142561975755705,"prev":0.24146547873382024,"temp":0.24142947813190782,"idx":0,"name":"AtmVolRef"},{"curr":-0.04344874800391943,"prev":-0.043985887374258278,"temp":-0.043455253210716333,"idx":1,"name":"SlopeRef"},{"curr":0.052192502920526768,"prev":0.052233001966072876,"temp":0.052314754628070739,"idx":2,"name":"PutCurv"},{"curr":0.057873697514790406,"prev":0.058011024350500415,"temp":0.057874610522949767,"idx":3,"name":"CallCurv"},{"curr":0,"prev":0,"temp":0,"idx":4,"name":"SSR"},{"curr":0,"prev":0,"temp":0,"idx":5,"name":"VCR"},{"curr":0,"prev":0,"temp":0,"idx":6,"name":"SCR"},{"curr":-4,"prev":-4,"temp":-4,"idx":7,"name":"DownCut"},{"curr":-6,"prev":-6,"temp":-6,"idx":8,"name":"DownSm"},{"curr":4,"prev":4,"temp":4,"idx":9,"name":"UpCut"},{"curr":6,"prev":6,"temp":6,"idx":10,"name":"UpSm"},{"curr":42370,"prev":42370,"temp":42370,"idx":11,"name":"PriceCurr"},{"curr":42370,"prev":42370,"temp":42370,"idx":12,"name":"PriceRef"},{"curr":0.010958904109589041,"prev":0.010958904109589041,"temp":0.010958904109589041,"idx":13,"name":"T"},{"curr":0,"prev":0,"temp":0,"idx":14,"name":"r"},{"curr":0,"prev":0,"temp":0,"idx":15,"name":"b"}]}}'

undlychg_str='{"dt":"2020-04-20 15:15:00.708013","ll":"LOG_INFO","msgtype":"msg_oc_onundlymktchanged","ocname":"oc_cu_o_20200525","S":42575,"pxundlymidpx":42575,"pxundlyratio":1,"pxundlyinstrid":"cu2006","undlybias":0,"T":0.0960484,"atmindex":16,"atmstrike":43000,"tsdur1":22,"tsdur2":255,"tsdur3":218,"tsdur4":518,"fitdt":"2020-04-20 15:14:28.680713","fitthreshticks":10,"minoptionpxtick":1,"theodiffvalue":0.0128516,"theodiffvalueweighted":10.199,"posdelta_oc":0,"posdeltanorm_oc":0,"posgamma_oc":0,"posgammanorm_oc":0,"posvega_oc":0,"posveganorm_oc":0,"postheta_oc":0,"posrho_oc":0,"strikes":[33500,34000,34500,35000,35500,36000,36500,37000,37500,38000,38500,39000,39500,40000,41000,42000,43000,44000,45000,46000,47000,48000,49000,50000,51000,52000,53000],"sds":[-3.81659,-3.57932,-3.34552,-3.11508,-2.88791,-2.66392,-2.44302,-2.22512,-2.01015,-1.79803,-1.58868,-1.38203,-1.17801,-0.976562,-0.581107,-0.195182,0.181662,0.549842,0.909747,1.26174,1.60617,1.94334,2.27356,2.59711,2.91425,3.22523,3.53029],"midvols":[0.359469,0.339697,0.323939,0.321998,0.311538,0.307213,0.292854,0.287635,0.27585,0.267486,0.254039,0.248085,0.238548,0.236454,0.2135,0.198611,0.189819,0.194042,0.200015,0.216115,0.225909,0.238515,0.252554,0.267933,0.283881,0.300803,0.326891],"theovols":[0.401085,0.381477,0.363077,0.345835,0.329706,0.314648,0.300618,0.287579,0.275492,0.264322,0.254036,0.244601,0.235986,0.228163,0.214777,0.204234,0.196626,0.194043,0.19665,0.204106,0.216099,0.232339,0.252559,0.276514,0.303972,0.334722,0.368566],"volweights":[181.794,214.6,257.398,313.564,387.596,485.375,614.379,783.718,1003.8,1285.34,1637.43,2064.52,2562.49,3114.79,4242.65,5066.64,5237.48,4712.83,3770.49,2765.77,1923.37,1307.53,890.55,618.373,442.48,328.017,252.266],"theovol_func":{"doubleparams":[{"curr":0.19938389909453003,"prev":0.19935333236429484,"temp":0.19937658068014197,"idx":0,"name":"AtmVolRef"},{"curr":-0.10151792439786933,"prev":-0.10126326958427628,"temp":-0.10144637364457978,"idx":1,"name":"SlopeRef"},{"curr":0.041048040503208538,"prev":0.040942394201829907,"temp":0.041094868642570448,"idx":2,"name":"PutCurv"},{"curr":0.096179011063525832,"prev":0.09622346850235329,"temp":0.0961568479698142,"idx":3,"name":"CallCurv"},{"curr":0,"prev":0,"temp":0,"idx":4,"name":"SSR"},{"curr":0,"prev":0,"temp":0,"idx":5,"name":"VCR"},{"curr":0,"prev":0,"temp":0,"idx":6,"name":"SCR"},{"curr":-4,"prev":-4,"temp":-4,"idx":7,"name":"DownCut"},{"curr":-6,"prev":-6,"temp":-6,"idx":8,"name":"DownSm"},{"curr":4,"prev":4,"temp":4,"idx":9,"name":"UpCut"},{"curr":6,"prev":6,"temp":6,"idx":10,"name":"UpSm"},{"curr":42575,"prev":42580,"temp":42575,"idx":11,"name":"PriceCurr"},{"curr":42575,"prev":42575,"temp":42575,"idx":12,"name":"PriceRef"},{"curr":0.096048411646290577,"prev":0.096048411646290577,"temp":0.096048411646290577,"idx":13,"name":"T"},{"curr":0.015,"prev":0.015,"temp":0.015,"idx":14,"name":"r"},{"curr":0,"prev":0,"temp":0,"idx":15,"name":"b"}]},"mktbidpxs_c":[9086,8592,8100,7609,7118,6630,6145,5662,5182,4708,4238,3775,3329,2893,2066,1364,819,486,283,170,108,68,47,34,24,20,25],"mktaskpxs_c":[9122,8622,8136,7635,7148,6660,6166,5683,5219,4740,4264,3800,3349,2915,2089,1378,835,493,288,175,112,72,50,36,25,23,27],"theopxs_c":[9109.96396,8611.93878,8114.88535,7618.98933,7124.51375,6631.82536,6141.43068,5654.02392,5170.54939,4692.27959,4220.90761,3758.64724,3308.32594,2873.4444,2067.18177,1377.6832,840.098799,476.945866,263.096588,149.457789,92.4549578,64.5766304,51.4878424,46.4229221,46.3617263,50.0638925,57.1546698],"mktbidpxs_p":[22,24,27,36,44,59,67,91,105,130,153,196,240,321,471,757,1208,1845,2650,3545,4477,5430,6415,7388,8377,9365,10364],"mktaskpxs_p":[23,25,28,37,45,60,70,92,108,132,157,201,247,326,483,766,1225,1861,2678,3571,4506,5468,6443,7427,8414,9405,10398],"theopxs_p":[48.0291388,49.2841145,51.5108334,54.894976,59.6995447,66.2913152,75.1767898,87.0501836,102.855811,123.866171,151.774343,188.794126,237.75298,302.1516,494.449276,803.511023,1264.48693,1899.89431,2684.60534,3569.52685,4511.08433,5481.76632,6467.23784,7460.73323,8459.23235,9461.49483,10467.1459],"netpos_c":[0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0],"netpos_p":[0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0],"delta_c":[0.975336,0.973683,0.971502,0.968654,0.964957,0.960168,0.95397,0.945945,0.935556,0.922126,0.90482,0.88266,0.854558,0.819416,0.724565,0.596483,0.446638,0.302008,0.189572,0.116548,0.0744107,0.0515173,0.03944,0.0333508,0.0307302,0.0302925,0.0313711],"delta_p":[-0.0232245,-0.0248771,-0.0270585,-0.0299065,-0.0336037,-0.0383921,-0.0445905,-0.0526154,-0.063004,-0.0764347,-0.0937401,-0.1159,-0.144002,-0.179145,-0.273995,-0.402078,-0.551923,-0.696552,-0.808988,-0.882013,-0.92415,-0.947043,-0.95912,-0.96521,-0.96783,-0.968268,-0.967189],"vega_c":[0.0724721,0.0767808,0.0823738,0.0895252,0.0985753,0.10994,0.124116,0.141676,0.163241,0.189429,0.220747,0.257428,0.299201,0.34501,0.439155,0.509909,0.521039,0.459787,0.357365,0.258447,0.185594,0.139322,0.112377,0.0979643,0.0915637,0.090482,0.0931408],"vega_p":[0.0724721,0.0767808,0.0823738,0.0895252,0.0985753,0.10994,0.124116,0.141676,0.163241,0.189429,0.220747,0.257428,0.299201,0.34501,0.439155,0.509909,0.521039,0.459787,0.357365,0.258447,0.185594,0.139322,0.112377,0.0979643,0.0915637,0.090482,0.0931408],"gamma_c":[1.03785e-05,1.15607e-05,1.30314e-05,1.48688e-05,1.71728e-05,2.00693e-05,2.37145e-05,2.82969e-05,3.40345e-05,4.11635e-05,4.99113e-05,6.04503e-05,7.28242e-05,8.68535e-05,0.000117444,0.000143405,0.000152205,0.0001361,0.00010438,7.27306e-05,4.93302e-05,3.44428e-05,2.55574e-05,2.03494e-05,1.73018e-05,1.55267e-05,1.45153e-05],"gamma_p":[1.03785e-05,1.15607e-05,1.30314e-05,1.48688e-05,1.71728e-05,2.00693e-05,2.37145e-05,2.82969e-05,3.40345e-05,4.11635e-05,4.99113e-05,6.04503e-05,7.28242e-05,8.68535e-05,0.000117444,0.000143405,0.000152205,0.0001361,0.00010438,7.27306e-05,4.93302e-05,3.44428e-05,2.55574e-05,2.03494e-05,1.73018e-05,1.55267e-05,1.45153e-05],"tsdur5":725,"tsdur":1738}'


j=json.loads(undlychg_str)

curvemgr=pyxt.XT.CurveSurfaceMgr.getInstance()
dwc=curvemgr.createCurve('doublewing')
dwf=dwc.func()
dwf.updateFromStr(json.dumps(j['theovol_func']),1)

strikes=j['strikes'] 
midvols=j['midvols']
sds=j['sds']
strikescale=1
nsize=len(strikes)
for i in range(0,nsize):
	X=strikes[i]
	intstrike=(int)(strikescale*X)
	midvol=midvols[i]
	dwc.setDataPoint(intstrike,X,midvol,0.0,0.0,1.0,0,0)



#c.updateFromStr(fitvolcurve_str,0)
#xs=c.dataXVector()
#ys=c.dataYVector()
#fitted_vols=c.getYVectorByFunc(0)

point_xs=[x for x in np.arange(strikes[0]-2000.0,strikes[-1]+2000.0,200)]
point_ys=[dwc.getYByFunc(x,0) for x in point_xs]

plt.plot(point_xs,point_ys,'b-')
plt.plot(strikes,midvols,'r*')

dwf.setDoubleParam(pyxt.XT.VolCurveParamType.DownSm.real,-4.0,0)
dwf.setDoubleParam(pyxt.XT.VolCurveParamType.DownCut.real,-2.0,0)
dwf.setDoubleParam(pyxt.XT.VolCurveParamType.UpSm.real,4.0,0)
dwf.setDoubleParam(pyxt.XT.VolCurveParamType.UpCut.real,2.0,0)
dwc.fit()

point_xs=[x for x in np.arange(strikes[0]-2000.0,strikes[-1]+2000.0,200)]
point_ys=[dwc.getYByFunc(x,0) for x in point_xs]
plt.plot(point_xs,point_ys,'b-')
plt.plot(strikes,midvols,'r*')

ws=dwc.dataWVector()
plt.plot(strikes,ws,'go')